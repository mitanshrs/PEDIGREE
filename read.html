<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PEDIGREE | Read</title>
    <script>
        (function() {
            const s = JSON.parse(localStorage.getItem('db_settings')) || {style:'modern', theme:'blue', appearance:'system'};
            const html = document.documentElement;
            html.classList.add('style-' + s.style);
            html.classList.add('theme-' + s.theme);
            let m = s.appearance;
            if (s.style === 'terminal') m = 'dark';
            else if (m === 'system') m = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            html.classList.add('mode-' + m);
        })();
    </script>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="logo.png">
    <style>
        .drill-down { border-left: 2px solid var(--accent); padding-left: 15px; margin: 10px 0; cursor: pointer; }
        .drill-down:hover { background: rgba(128, 128, 128, 0.1); }
        .meta-label { color: var(--accent); font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }
        .path-nav { font-size: 0.8rem; margin-bottom: 20px; opacity: 0.7; }
        .simple-edit-link { 
            float: right; text-decoration: none; font-size: 0.75rem; 
            color: var(--accent); border: 1px solid var(--accent); padding: 2px 8px; 
            font-weight: bold; transition: 0.2s; 
        }
        .simple-edit-link:hover { background: var(--accent); color: white; }
        .style-terminal .simple-edit-link:hover { color: #000; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .result-header h3 { margin: 0; }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <nav>
        <div style="flex: 1; display: flex; align-items: center; gap: 1rem; justify-content: center; margin-left: 45px;">
            <img src="logo.png" width="35px" height="35px">
            <a href="index.html">Home</a>
            <a href="write.html">Write</a>
            <a href="read.html" style="text-decoration: underline;">Read</a>
            <a href="list.html">List</a>
            <a href="transfer.html">Sync</a>
        </div>
        <div style="width: 45px; display: flex; justify-content: flex-end;">
            <a href="settings.html" title="Settings" style="padding: 0; font-size: 1.2rem;">⚙️</a>
        </div>
    </nav>
    <div class="container">
        <h1 class="title">PEDIGREE</h1>
        <h1>READ DATABASE</h1>
        <div class="card">
            <label>KEY INPUT (12-Digit, 6-Char, or Full 12-6-1)</label>
            <input type="text" id="queryInput" placeholder="INPUT KEY...">
            <button onclick="processQuery()">FIND</button>
        </div>
        <div id="outputContainer" class="card" style="display:none;">
            <div id="pathTracker" class="path-nav"></div>
            <div id="resultsContent"></div>
        </div>
    </div>
    <script src="logic.js"></script>
    <script>
        const out = document.getElementById('resultsContent');
        const box = document.getElementById('outputContainer');
        const path = document.getElementById('pathTracker');

        window.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const searchValue = params.get('search');
            if (searchValue) {
                document.getElementById('queryInput').value = searchValue;
                processQuery();
            }
        });

        function processQuery() {
            const q = document.getElementById('queryInput').value.trim();
            if(!q) return;
            box.style.display = "block"; out.innerHTML = "";
            const parts = q.split('-');
            if (parts.length === 3) showIdentity(parts[0], parts[1], parts[2]);
            else if (q.length === 12) showItemGroups(q);
            else if (q.length === 6 || batches[q]) showBatchGroups(q);
            else out.innerHTML = "> ERROR: INVALID KEY";
        }

        function showItemGroups(itemId) {
            path.innerText = `PATH: ITEM_${itemId}`;
            if (!items[itemId]) return out.innerHTML = "> ERR: BLUEPRINT NOT FOUND";
            out.innerHTML = `<div class="result-header"><h3>BLUEPRINT: ${items[itemId].name}</h3><a href="edit.html?id=${itemId}" class="simple-edit-link">EDIT</a></div><p class="meta-label">Batches Associated:</p>`;
            for (let bID in batches) {
                if (batches[bID][itemId]) {
                    const div = document.createElement('div'); div.className = "drill-down";
                    div.innerHTML = `> BATCH: ${bID} (${Object.keys(batches[bID][itemId]).length} Units)`;
                    div.onclick = () => showBatchItems(bID, itemId); out.appendChild(div);
                }
            }
        }

        function showBatchGroups(batchId) {
            path.innerText = `PATH: BATCH_${batchId}`;
            if (!batches[batchId]) return out.innerHTML = "> ERR: BATCH NOT FOUND";
            out.innerHTML = `<div class="result-header"><h3>BATCH: ${batchId}</h3><a href="edit.html?id=${batchId}" class="simple-edit-link">EDIT</a></div><p class="meta-label">Blueprints:</p>`;
            for (let iID in batches[batchId]) {
                const div = document.createElement('div'); div.className = "drill-down";
                div.innerHTML = `> TYPE: ${items[iID]?.name || iID}`;
                div.onclick = () => showBatchItems(batchId, iID); out.appendChild(div);
            }
        }

        function showBatchItems(bID, iID) {
            path.innerText = `PATH: ${bID} / ${iID}`;
            out.innerHTML = `<h3>UNITS IN BATCH</h3>`;
            const units = batches[bID][iID];
            for (let uID in units) {
                const div = document.createElement('div'); div.className = "drill-down";
                div.innerHTML = `> ID: ${uID} (Owner: ${units[uID].current_owner})`;
                div.onclick = () => showIdentity(iID, bID, uID); out.appendChild(div);
            }
        }

        function showIdentity(i12, b6, u1) {
            const data = batches[b6]?.[i12]?.[u1];
            if (!data) return out.innerHTML = "> ERR: IDENTITY VOID";
            out.innerHTML = `<div class="result-header"><h3>IDENTITY: ${u1}</h3><a href="edit.html?id=${i12}-${b6}-${u1}" class="simple-edit-link">EDIT</a></div>
                             <div class=""><p class="meta-label">NAME:</p><p>${items[i12].name}</p><p class="meta-label">ID:</p><p>${i12}</p><p class="meta-label">Batch id:</p><p>${b6}</p></div>
                             <div class="card"><p class="meta-label">Owner</p><p>${data.current_owner}</p><p class="meta-label">Location</p><p>${data.location || 'N/A'}</p></div><h3>HISTORY</h3>${data.history.map((h, idx) => `<div class="card" style="font-size:0.7rem; border-left: 2px solid ${idx === data.history.length-1 ? 'var(--accent)' : '#333'}">[${h.date}] ${h.from} -> ${h.to}</div>`).reverse().join('')}`;
        }
    </script>
    <p class="mitansh-ud">By Mitansh Udernani</p>
</body>
</html>