<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PEDIGREE | READ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="logo.png">
    <style>
        .drill-down { border-left: 2px solid var(--accent); padding-left: 15px; margin: 10px 0; cursor: pointer; }
        .drill-down:hover { background: rgba(233, 69, 96, 0.1); }
        .meta-label { color: var(--terminal); font-size: 0.7rem; text-transform: uppercase; }
        .path-nav { font-size: 0.8rem; margin-bottom: 20px; color: var(--accent); }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <nav>
        <img src="logo.png"width="35px" height="35px">
        <a href="index.html">> HOME</a>
        <a href="write.html">> WRITE</a>
        <a href="read.html" style="color: var(--terminal);">> READ</a>
        <a href="list.html">> LIST</a>
        <a href="transfer.html">> SYNC</a>
    </nav>
    
    <div class="container">
        <h1 class="title">PEDIGREE</h1>
        <h1>[ DATA_QUERY_MODULE ]</h1>
        
        <div class="card">
            <label>QUERY_INPUT (12-Digit, 6-Char, or Full 12-6-1)</label>
            <input type="text" id="queryInput" placeholder="INPUT_KEY...">
            <button onclick="processQuery()">EXECUTE_QUERY</button>
        </div>

        <div id="outputContainer" class="card" style="display:none;">
            <div id="pathTracker" class="path-nav"></div>
            <div id="resultsContent"></div>
        </div>
    </div>
    <p class="mitansh-ud">By Mitansh Udernani</p>
    <script src="logic.js"></script>
    <script>
        const out = document.getElementById('resultsContent');
        const box = document.getElementById('outputContainer');
        const path = document.getElementById('pathTracker');

        // Check URL for search parameter and auto-execute
        window.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const searchValue = params.get('search');
            if (searchValue) {
                document.getElementById('queryInput').value = searchValue;
                processQuery();
            }
        });

        function processQuery() {
            const q = document.getElementById('queryInput').value.trim();
            box.style.display = "block";
            out.innerHTML = "";
            
            const parts = q.split('-');

            if (parts.length === 3) {
                showIdentity(parts[0], parts[1], parts[2]);
            } else if (q.length === 12) {
                showItemGroups(q);
            } else if (q.length === 6 || batches[q]) {
                showBatchGroups(q);
            } else {
                out.innerHTML = "> ERROR: INVALID_KEY_LENGTH";
            }
        }

        // 1. View all Batches for a specific Item
        function showItemGroups(itemId) {
            path.innerText = `PATH: ITEM_${itemId}`;
            if (!items[itemId]) return out.innerHTML = "> ERR: BLUEPRINT_NOT_FOUND";
            
            out.innerHTML = `<h3>BLUEPRINT: ${items[itemId].name}</h3><p class="meta-label">Grouped by Batch:</p>`;
            
            let found = false;
            for (let bID in batches) {
                if (batches[bID][itemId]) {
                    found = true;
                    const unitCount = Object.keys(batches[bID][itemId]).length;
                    const div = document.createElement('div');
                    div.className = "drill-down";
                    div.innerHTML = `> BATCH: ${bID} (${unitCount} Identities Found)`;
                    div.onclick = () => showBatchItems(bID, itemId);
                    out.appendChild(div);
                }
            }
            if (!found) out.innerHTML += "> NO_PRODUCTION_HISTORY_FOUND";
        }

        // 2. View all Items in a specific Batch
        function showBatchGroups(batchId) {
            path.innerText = `PATH: BATCH_${batchId}`;
            if (!batches[batchId]) return out.innerHTML = "> ERR: BATCH_NOT_FOUND";

            out.innerHTML = `<h3>BATCH_CONTENTS: ${batchId}</h3><p class="meta-label">Select Item Category:</p>`;
            
            for (let iID in batches[batchId]) {
                const name = items[iID]?.name || "UNKNOWN_TYPE";
                const div = document.createElement('div');
                div.className = "drill-down";
                div.innerHTML = `> TYPE: ${name} (${iID})`;
                div.onclick = () => showBatchItems(batchId, iID);
                out.appendChild(div);
            }
        }

        // 3. List unique identities for a specific Batch + Item pair
        function showBatchItems(bID, iID) {
            path.innerText = `PATH: BATCH_${bID} / ITEM_${iID}`;
            out.innerHTML = `<h3>IDENTITIES IN ${bID}</h3>`;
            
            const units = batches[bID][iID];
            for (let uID in units) {
                const div = document.createElement('div');
                div.className = "drill-down";
                div.innerHTML = `> IDENTITY_CODE: ${uID} (Owner: ${units[uID].current_owner})`;
                div.onclick = () => showIdentity(iID, bID, uID);
                out.appendChild(div);
            }
            const back = document.createElement('button');
            back.innerText = "<< RETURN_TO_GROUP";
            back.style.marginTop = "20px";
            back.onclick = () => processQuery();
            out.appendChild(back);
        }

        // 4. Final detail view for one specific 12-6-1 Identity
        function showIdentity(i12, b6, u1) {
            path.innerText = `PATH: ${i12}-${b6}-${u1}`;
            const data = batches[b6]?.[i12]?.[u1];
            if (!data) return out.innerHTML = "> ERR: IDENTITY_VOID";

            out.innerHTML = `
                <h3>IDENTITY_REPORT: ${u1}</h3>
                <div class="card">
                    <p class="meta-label">Blueprint</p>
                    <p>${items[i12].name} (${i12})</p>
                    <p class="meta-label">Current Custodian</p>
                    <p>${data.current_owner}</p>
                </div>
                <h3>TRANSFER_OWNERSHIP</h3>
                <div class="card">
                    <p class="meta-label">From</p>
                    <input type="text" id="transferFrom" placeholder="Current Owner" value="${data.current_owner}" readonly>
                    <p class="meta-label">To</p>
                    <input type="text" id="transferTo" placeholder="New Owner">
                    <p class="meta-label">Location</p>
                    <input type="text" id="transferLocation" placeholder="Transfer Location">
                    <p class="meta-label">Date/Time</p>
                    <select id="timeOption">
                        <option value="now">RIGHT_NOW</option>
                        <option value="custom">CUSTOM</option>
                    </select>
                    <input type="datetime-local" id="customTime" style="display:none; margin-top: 10px;">
                    <button onclick="submitTransfer('${i12}', '${b6}', '${u1}')" style="margin-top: 10px;">CONFIRM_TRANSFER</button>
                </div>
                <h3>CUSTODY_LOG</h3>
                ${data.history.map(h => `<div class="card" style="font-size:0.7rem">
                    [${h.date}]<br>FROM: ${h.from}<br>TO: ${h.to}<br>LOCATION: ${h.location || 'N/A'}
                </div>`).reverse().join('')}
            `;
            
            const timeSelect = out.querySelector('#timeOption');
            const customTimeInput = out.querySelector('#customTime');
            timeSelect.addEventListener('change', function() {
                customTimeInput.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            const back = document.createElement('button');
            back.innerText = "<< BACK_TO_BATCH";
            back.onclick = () => showBatchItems(b6, i12);
            out.appendChild(back);
        }

        function submitTransfer(i12, b6, u1) {
    const from = document.getElementById('transferFrom').value;
    const to = document.getElementById('transferTo').value;
    const location = document.getElementById('transferLocation').value;
    const timeOption = document.getElementById('timeOption').value;
    const customTime = document.getElementById('customTime').value;

    if (!to || !location) {
        alert("ERROR: MISSING_REQUIRED_FIELDS");
        return;
    }

    const date = timeOption === 'now' ? new Date().toLocaleString() : new Date(customTime).toLocaleString();
    
    const data = batches[b6][i12][u1];
    
    // Write transfer history to the unique identity
    const historyEntry = {
        from: from,
        to: to,
        location: location,
        date: date
    };
    
    data.history.push(historyEntry);
    data.current_owner = to;
    
    // Persist the update to LocalStorage
    sync();
    
    // Notify user and REFRESH the UI to show the new history entry
    alert("TRANSFER_RECORDED_SUCCESSFULLY");
    showIdentity(i12, b6, u1);
}
    </script>
</body>
</html>
